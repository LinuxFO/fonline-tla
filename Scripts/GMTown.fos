// FOS Server Client
// TODO: При движении в группе неизвестно, что будет, если не лидер группы посмотрит город.
///@ RemoteCall Client ShowTownView(int locId, int mapIndex)
///@ RemoteCall Client ShowGMTown(int locId, hstring locPid, int[] indexMaps)

///@ RemoteCall Server Rpc_TransitToMap(int locId, int mapIndex)
///@ RemoteCall Server Rpc_ShowTownView(int locId, int mapIndex)
///@ RemoteCall Server Rpc_ShowGMTown()

#ifdef __SERVER

void Rpc_ShowGMTown(Critter cr)
{
    Location[] locs = {};
    locs = GetVisibleLocations(cr.WorldX, cr.WorldY, 0, cr);
    if (locs.length() == 0)
        return;

    Location loc = locs[0];
    hstring[] entraceMaps = loc.MapEntrances.clone();
    hstring[] mapProtos = loc.MapProtos.clone();
    int[] indexMaps = {};
    for (uint i = 0; i < entraceMaps.length(); i += 2)
        indexMaps.insertLast(mapProtos.find(entraceMaps[i]));

    cr.ClientCall.ShowGMTown(loc.Id, loc.ProtoId, indexMaps);
}

void Rpc_ShowTownView(Critter cr, int locId, int mapIndex)
{
    Location loc = GetLocation(locId);
    Map map = loc.GetMapByIndex(mapIndex);
    hstring[] entraceMaps = loc.MapEntrances.clone();
    int entNum = entraceMaps.find(map.ProtoId);
    if (entNum == -1)
        return;

    entNum = entraceMaps[entNum + 1];
    uint16 hx = 0, hy = 0;
    // cr.ClientCall.ShowTownView( locId, mapIndex );
    // Entire::MapGetEntireCoords( map,  entNum, 0, hx, hy  );
    // cr.ViewMap( map, 40, map.Width / 2, map.Height / 2, 3 );
}

void Rpc_TransitToMap(Critter cr, int locId, int mapIndex)
{
    Location loc = GetLocation(locId);
    Map map = loc.GetMapByIndex(mapIndex);
    hstring[] entraceMaps = loc.MapEntrances.clone();
    int entNum = entraceMaps.find(map.ProtoId);
    if (entNum == -1)
        return;
    entNum = entraceMaps[entNum + 1];
    uint16 hx = 0, hy = 0;
    Entire::MapGetEntireCoords(map, entNum, 0, hx, hy);
    Obsolete::CritterTransitToMapCoords(cr, map.Id, map.Width / 2, map.Height / 2, Random(0, 5));
}
#endif

#ifdef __CLIENT
void ShowGMTown(int locId, hstring locPid, int[] indexMaps)
{
    ShowScreen(CLIENT_SCREEN_GM_TOWN, UtilsForArray::DictionaryToDict(dictionary = {{"LocationId", locId}, {"LocationPid", locPid}, {"IndexMaps", indexMaps}}));
}

int CurrentLocationId;
int CurrentEntrance;

void ShowTownView(int locId, int entrance)
{
    HideScreen();

    CurrentLocationId = locId;
    CurrentEntrance = entrance;

    // r17: движок сам показывает этот скрин при просмотре карты, но с пустым контекстом (без ид локации и номера энтайра)
    // Скрин может быть показан позже скриптового вызова
    // HideScreen( CLIENT_SCREEN_TOWN_VIEW );
    // ShowScreen( CLIENT_SCREEN_TOWN_VIEW, UtilsForArray::DictionaryToDict(dictionary = {{"LocationId", locId}, {"LocationEntrance", entrance}}) );
}
#endif
